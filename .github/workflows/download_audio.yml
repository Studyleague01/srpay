name: Download Audio File
on:
  workflow_dispatch:
    inputs:
      video_id:
        description: 'Enter video ID'
        required: true
        type: string
jobs:
  download:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install yt-dlp and ffmpeg
        run: |
          sudo apt update
          sudo apt install -y yt-dlp ffmpeg

      - name: Create directory
        run: mkdir -p downloads

      - name: Download audio
        run: |
          VIDEO_ID="${{ github.event.inputs.video_id }}"
          
          # Set your PO-Token and Visitor Data here
          VISITOR_DATA="CgtPVjFoelNvaElPVSisxaK9BjIKCgJJThIEGgAgVw%3D%3D"
          PO_TOKEN="IjjTnNOftDRxMZD7p8yF9pXztvCd6rLZv8yFz7rvq_2YpZH2mteQ-5nWh_Sa2ZT7kvuF6_avl7ng2A=="
          
          yt-dlp -f bestaudio -x --audio-format mp3 \
            --add-header "X-YouTube-Client-Visitor-Data: $VISITOR_DATA" \
            --add-header "X-YouTube-EOM-Visitor-Data: $VISITOR_DATA" \
            --add-header "X-Goog-AuthUser: 0" \
            --add-header "Authorization: SAPISIDHASH $PO_TOKEN" \
            -o "downloads/${VIDEO_ID}.mp3" "https://www.youtube.com/watch?v=${VIDEO_ID}"

      - name: Setup git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Commit files
        run: |
          git add downloads/
          git diff --staged --quiet || (git commit -m "Added audio file ${{ github.event.inputs.video_id }}.mp3" && git push)
